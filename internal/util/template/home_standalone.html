<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - AI Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .loading {
            display: none;
        }

        .result-card {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
        }

        .provider-info {
            background-color: #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>AI Service
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Home</a>
                <a class="nav-link" href="/history"><i class="fas fa-history me-1"></i>History</a>
                <a class="nav-link" href="/stats"><i class="fas fa-chart-bar me-1"></i>Stats</a>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-magic me-2"></i>AI Content Generation
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="generationForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="provider" class="form-label">AI Provider</label>
                                    <select class="form-select" id="provider" name="provider" required>
                                        <option value="">Select Provider</option>
                                        {{range $provider, $info := .Providers}}
                                        <option value="{{$provider}}">{{$info.Name}}</option>
                                        {{end}}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="model" class="form-label">Model</label>
                                    <select class="form-select" id="model" name="model" required>
                                        <option value="">Select Model</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="temperature" class="form-label">Temperature</label>
                                    <input type="range" class="form-range" id="temperature" name="temperature" min="0"
                                        max="1" step="0.1" value="0.7">
                                    <small class="text-muted">Current: <span id="tempValue">0.7</span></small>
                                </div>
                                <div class="col-md-6">
                                    <label for="maxTokens" class="form-label">Max Tokens</label>
                                    <input type="number" class="form-control" id="maxTokens" name="maxTokens" min="1"
                                        max="8192" value="1000">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="systemMsg" class="form-label">System Message (Optional)</label>
                                <textarea class="form-control" id="systemMsg" name="systemMsg" rows="2"
                                    placeholder="Set the AI's role or behavior..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="prompt" class="form-label">Prompt</label>
                                <textarea class="form-control" id="prompt" name="prompt" rows="6"
                                    placeholder="Enter your prompt here..." required></textarea>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-magic me-2"></i>Generate Content
                                </button>
                            </div>
                        </form>

                        <div id="providerInfo" class="provider-info" style="display: none;"></div>

                        <div id="loading" class="loading text-center mt-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Generating content...</p>
                        </div>

                        <div id="result" class="result-card mt-4" style="display: none;">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-check-circle text-success me-2"></i>Generated Content
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="resultContent"></div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>Duration: <span id="resultDuration"></span> |
                                        <i class="fas fa-tokens me-1"></i>Tokens: <span id="resultTokens"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-lightbulb me-2"></i>Quick Examples
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <button type="button" class="list-group-item list-group-item-action"
                                onclick="loadExample('code')">
                                <i class="fas fa-code me-2"></i>Code Generation
                            </button>
                            <button type="button" class="list-group-item list-group-item-action"
                                onclick="loadExample('writing')">
                                <i class="fas fa-pen me-2"></i>Content Writing
                            </button>
                            <button type="button" class="list-group-item list-group-item-action"
                                onclick="loadExample('analysis')">
                                <i class="fas fa-chart-line me-2"></i>Data Analysis
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Tips
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Be specific in your prompts
                            </li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use system messages for
                                context</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Adjust temperature for
                                creativity</li>
                            <li><i class="fas fa-check text-success me-2"></i>Set appropriate token limits</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden data elements for JavaScript -->
    <div id="provider-models-data" data-json='{{.ProviderModelsJSON | safe}}' style="display: none;"></div>
    <div id="provider-data" data-json='{{.ProvidersJSON | safe}}' style="display: none;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // FIXED VERSION - Handle HTML-escaped JSON properly
        let providerModels, providerData;

        // Function to decode HTML entities
        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        try {
            const modelsElement = document.getElementById('provider-models-data');
            const dataElement = document.getElementById('provider-data');

            if (modelsElement && dataElement) {
                const modelsJson = decodeHtmlEntities(modelsElement.getAttribute('data-json'));
                const dataJson = decodeHtmlEntities(dataElement.getAttribute('data-json'));

                providerModels = JSON.parse(modelsJson);
                providerData = JSON.parse(dataJson);
                console.log('Provider data loaded successfully:', providerModels);
            } else {
                console.error('Provider data elements not found');
                providerModels = {};
                providerData = {};
            }
        } catch (error) {
            console.error('Error parsing provider data:', error);
            providerModels = {};
            providerData = {};
        }

        // Update models when provider changes
        document.getElementById('provider').addEventListener('change', function () {
            const provider = this.value;
            const modelSelect = document.getElementById('model');
            const providerInfo = document.getElementById('providerInfo');

            modelSelect.innerHTML = '<option value="">Select Model</option>';

            if (provider && providerModels[provider]) {
                providerModels[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });

                if (providerData[provider]) {
                    const info = providerData[provider];
                    providerInfo.innerHTML = `
                        <h6>${info.Name}</h6>
                        <p class="small text-muted">${info.Strengths || 'No description available'}</p>
                        <div class="small">
                            <strong>Best for:</strong> ${info.BestFor || 'General use'}<br>
                            <strong>Max tokens:</strong> ${info.MaxTokens || 'Unknown'}<br>
                            <strong>Pricing:</strong> ${info.Pricing || 'Contact provider'}
                        </div>
                    `;
                    providerInfo.style.display = 'block';
                }
            } else {
                providerInfo.style.display = 'none';
            }
        });

        // Update temperature display
        document.getElementById('temperature').addEventListener('input', function () {
            document.getElementById('tempValue').textContent = this.value;
        });

        // Form submission
        document.getElementById('generationForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {
                provider: formData.get('provider'),
                model: formData.get('model'),
                prompt: formData.get('prompt'),
                systemMsg: formData.get('systemMsg'),
                temperature: parseFloat(formData.get('temperature')),
                maxTokens: parseInt(formData.get('maxTokens'))
            };

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('resultContent').innerHTML = result.content.replace(/\n/g, '<br>');
                    document.getElementById('resultDuration').textContent = result.duration;
                    document.getElementById('resultTokens').textContent = result.tokens_used;
                    document.getElementById('result').style.display = 'block';
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Load example prompts
        function loadExample(type) {
            const examples = {
                code: {
                    systemMsg: 'You are an expert software developer. Write clean, efficient, and well-documented code.',
                    prompt: 'Write a function in Go that validates an email address using regex.'
                },
                writing: {
                    systemMsg: 'You are a professional content writer. Create engaging and informative content.',
                    prompt: 'Write a blog post introduction about the benefits of artificial intelligence in modern business.'
                },
                analysis: {
                    systemMsg: 'You are a data analyst. Provide clear insights and actionable recommendations.',
                    prompt: 'Analyze the impact of remote work on productivity and provide recommendations for companies.'
                }
            };

            const example = examples[type];
            if (example) {
                document.getElementById('systemMsg').value = example.systemMsg;
                document.getElementById('prompt').value = example.prompt;
            }
        }
    </script>
</body>

</html>